<html><head><base href="https://webdevgalaxy.com/bonzichat/">
<title>BonziChat - Windows 98 Style</title>
<link rel="stylesheet" href="https://unpkg.com/98.css">
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
<style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: "MS Sans Serif", Arial, sans-serif;
}
#chatContainer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100px;
    background-color: #c0c0c0;
    border-top: 2px solid #fff;
    box-shadow: inset 1px 1px #dfdfdf, 1px 0 #000, 0 1px #000, 1px 1px #000;
}
#chatInput {
    width: calc(100% - 80px);
    height: 30px;
    margin: 10px;
}
#sendButton {
    width: 60px;
    height: 30px;
    vertical-align: top;
}
#uploadButton {
    position: absolute;
    right: 10px;
    bottom: 10px;
}
.bonzi {
    position: absolute;
    width: 200px;
    height: 160px;
    cursor: move;
}
.speech-bubble {
    position: absolute;
    background: #fff;
    border: 2px solid #000;
    border-radius: 10px;
    padding: 10px;
    max-width: 200px;
    word-wrap: break-word;
    display: none;
}
.nametag {
    position: absolute;
    background: #000080;
    color: #fff;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 12px;
}
.admin-tag {
    background: #ff0000;
    margin-left: 5px;
}
#loginWindow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}
</style>
</head>
<body>
<div id="loginWindow" class="window">
    <div class="title-bar">
        <div class="title-bar-text">Login to BonziChat</div>
    </div>
    <div class="window-body">
        <p>Enter your nickname and room ID:</p>
        <div class="field-row">
            <label for="nickname">Nickname:</label>
            <input id="nickname" type="text">
        </div>
        <div class="field-row">
            <label for="roomId">Room ID:</label>
            <input id="roomId" type="text">
        </div>
        <div class="field-row">
            <button id="loginButton">Login</button>
        </div>
    </div>
</div>

<div id="chatContainer">
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button id="sendButton">Send</button>
    <button id="uploadButton">Upload</button>
</div>

<script>
const socket = io();
let myBonzi;
let bonzis = {};
let myNickname = '';
let myColor = '';
let isAdmin = false;

const bonziColors = [
    'purple', 'brown', 'blue', 'black', 'green', 'pink', 'red'
];

const bonziSprites = {
    purple: 'https://250750.xyz/img/bonzi/purple.png',
    brown: 'https://250750.xyz/img/bonzi/brown.png',
    blue: 'https://250750.xyz/img/bonzi/blue.png',
    black: 'https://250750.xyz/img/bonzi/black.png',
    green: 'https://250750.xyz/img/bonzi/green.png',
    pink: 'https://250750.xyz/img/bonzi/pink.png',
    red: 'https://250750.xyz/img/bonzi/red.png'
};

const bonziAnimations = {
    idle: [0],
    enter: [277, 302, "idle", 0.25],
    leave: [16, 39, 40, 0.25]
};

function createBonzi(id, color, x, y) {
    const bonziContainer = document.createElement('div');
    bonziContainer.className = 'bonzi';
    bonziContainer.style.left = x + 'px';
    bonziContainer.style.top = y + 'px';

    const canvas = document.createElement('canvas');
    canvas.width = 200;
    canvas.height = 160;
    bonziContainer.appendChild(canvas);

    const speechBubble = document.createElement('div');
    speechBubble.className = 'speech-bubble';
    bonziContainer.appendChild(speechBubble);

    const nametag = document.createElement('div');
    nametag.className = 'nametag';
    nametag.textContent = id;
    bonziContainer.appendChild(nametag);

    document.body.appendChild(bonziContainer);

    const stage = new createjs.Stage(canvas);
    const spriteSheet = new createjs.SpriteSheet({
        images: [bonziSprites[color]],
        frames: {width: 200, height: 160},
        animations: bonziAnimations
    });

    const sprite = new createjs.Sprite(spriteSheet, "idle");
    stage.addChild(sprite);
    createjs.Ticker.timingMode = createjs.Ticker.RAF;
    createjs.Ticker.addEventListener("tick", stage);

    makeDraggable(bonziContainer);

    return {
        container: bonziContainer,
        sprite: sprite,
        speechBubble: speechBubble,
        nametag: nametag,
        stage: stage
    };
}

function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    element.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

function speak(bonzi, text) {
    bonzi.speechBubble.textContent = text;
    bonzi.speechBubble.style.display = 'block';
    bonzi.sprite.gotoAndPlay("talk");

    const url = "https://www.tetyys.com/SAPI4/SAPI4?text=" + encodeURIComponent(text) + "&voice=" + encodeURIComponent("Adult Male #2, American English (TruVoice)") + "&pitch=140&speed=157";
    const audio = new Audio(url);
    audio.play();

    setTimeout(() => {
        bonzi.speechBubble.style.display = 'none';
        bonzi.sprite.gotoAndPlay("idle");
    }, text.length * 100);
}

document.getElementById('loginButton').addEventListener('click', () => {
    myNickname = document.getElementById('nickname').value;
    const roomId = document.getElementById('roomId').value;
    if (myNickname && roomId) {
        socket.emit('join', { user: myNickname, room: roomId });
        document.getElementById('loginWindow').style.display = 'none';
    }
});

socket.on('joined', (data) => {
    myColor = bonziColors[Math.floor(Math.random() * bonziColors.length)];
    myBonzi = createBonzi(data.user, myColor, Math.random() * (window.innerWidth - 200), Math.random() * (window.innerHeight - 260));
    bonzis[data.user] = myBonzi;
    myBonzi.sprite.gotoAndPlay("enter");
});

socket.on('userJoined', (data) => {
    const color = bonziColors[Math.floor(Math.random() * bonziColors.length)];
    const newBonzi = createBonzi(data.user, color, Math.random() * (window.innerWidth - 200), Math.random() * (window.innerHeight - 260));
    bonzis[data.user] = newBonzi;
    newBonzi.sprite.gotoAndPlay("enter");
});

socket.on('userLeft', (data) => {
    if (bonzis[data.id]) {
        bonzis[data.id].sprite.gotoAndPlay("leave");
        setTimeout(() => {
            bonzis[data.id].container.remove();
            delete bonzis[data.id];
        }, 1000);
    }
});

socket.on('chat', (data) => {
    if (bonzis[data.user]) {
        speak(bonzis[data.user], data.text);
    }
});

document.getElementById('sendButton').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (text) {
        if (text.startsWith('/')) {
            handleCommand(text);
        } else {
            socket.emit('chat', { text: text });
        }
        input.value = '';
    }
}

function handleCommand(command) {
    const parts = command.split(' ');
    switch (parts[0]) {
        case '/name':
            if (parts[1]) {
                socket.emit('changeName', { newName: parts[1] });
            }
            break;
        case '/color':
            if (parts[1] && bonziColors.includes(parts[1])) {
                myColor = parts[1];
                socket.emit('changeColor', { color: myColor });
            }
            break;
        case '/image':
            if (parts[1]) {
                socket.emit('sendImage', { url: parts[1] });
            }
            break;
    }
}

document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    if (e.target.closest('.bonzi')) {
        const bonzi = e.target.closest('.bonzi');
        const user = bonzi.querySelector('.nametag').textContent;
        if (user !== myNickname) {
            showContextMenu(e.clientX, e.clientY, user);
        }
    }
});

function showContextMenu(x, y, user) {
    const menu = document.createElement('div');
    menu.className = 'window';
    menu.style.position = 'absolute';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.zIndex = '1000';

    const content = document.createElement('div');
    content.className = 'window-body';
    menu.appendChild(content);

    const kickButton = document.createElement('button');
    kickButton.textContent = 'Kick User';
    kickButton.onclick = () => {
        if (isAdmin) {
            socket.emit('kickUser', { user: user });
        }
        document.body.removeChild(menu);
    };
    content.appendChild(kickButton);

    document.body.appendChild(menu);

    document.addEventListener('click', function removeMenu() {
        if (menu && menu.parentElement) {
            menu.parentElement.removeChild(menu);
        }
        document.removeEventListener('click', removeMenu);
    });
}

document.getElementById('uploadButton').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            socket.emit('sendImage', { url: event.target.result });
        };
        reader.readAsDataURL(file);
    };
    input.click();
});

document.addEventListener('paste', (e) => {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = (event) => {
                socket.emit('sendImage', { url: event.target.result });
            };
            reader.readAsDataURL(blob);
        }
    }
});

socket.on('imageMessage', (data) => {
    if (bonzis[data.user]) {
        const img = document.createElement('img');
        img.src = data.url;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100px';
        bonzis[data.user].speechBubble.innerHTML = '';
        bonzis[data.user].speechBubble.appendChild(img);
        bonzis[data.user].speechBubble.style.display = 'block';
        setTimeout(() => {
            bonzis[data.user].speechBubble.style.display = 'none';
        }, 5000);
    }
});

socket.on('nameChanged', (data) => {
    if (bonzis[data.oldName]) {
        bonzis[data.newName] = bonzis[data.oldName];
        delete bonzis[data.oldName];
        bonzis[data.newName].nametag.textContent = data.newName;
        if (data.oldName === myNickname) {
            myNickname = data.newName;
        }
    }
});

socket.on('colorChanged', (data) => {
    if (bonzis[data.user]) {
        const newSprite = new createjs.Sprite(new createjs.SpriteSheet({
            images: [bonziSprites[data.color]],
            frames: {width: 200, height: 160},
            animations: bonziAnimations
        }), "idle");
        bonzis[data.user].stage.removeChild(bonzis[data.user].sprite);
        bonzis[data.user].stage.addChild(newSprite);
        bonzis[data.user].sprite = newSprite;
    }
});

socket.on('kicked', () => {
    alert('You have been kicked from the room.');
    window.location.reload();
});

socket.on('adminStatus', (status) => {
    isAdmin = status;
    if (isAdmin && myBonzi) {
        const adminTag = document.createElement('span');
        adminTag.className = 'admin-tag';
        adminTag.textContent = 'ADMIN';
        myBonzi.nametag.appendChild(adminTag);
    }
});
</script>
</body>
</html>
