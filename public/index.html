<html><head><base href="https://bonziworld.org/"></head>
<body>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/98.css">

<style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: "MS Sans Serif", Arial, sans-serif;
}
#bonziWorld {
    width: 100%;
    height: calc(100% - 30px);
    position: relative;
}
.bonzi {
    position: absolute;
    width: 200px;
    height: 160px;
    cursor: move;
}
.speechBubble, .nameBubble {
    position: absolute;
    background: #fff;
    border: 2px solid #000;
    border-radius: 10px;
    padding: 5px;
    max-width: 200px;
    word-wrap: break-word;
}
.nameBubble {
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
}
.adminTag {
    background: red;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    margin-left: 5px;
}
#chatBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    display: flex;
}
#chatInput {
    flex-grow: 1;
}
#loginModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}
</style>

<div id="bonziWorld"></div>
<div id="chatBar">
    <input type="text" id="chatInput" class="win98-input" placeholder="Chat here...">
    <button id="sendBtn" class="win98-button">Send</button>
    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
    <button id="uploadBtn" class="win98-button">Upload Image</button>
</div>

<div id="loginModal" class="window">
    <div class="title-bar">
        <div class="title-bar-text">Login</div>
    </div>
    <div class="window-body">
        <p>Enter your nickname and room ID:</p>
        <input type="text" id="nicknameInput" class="win98-input" placeholder="Nickname">
        <input type="text" id="roomInput" class="win98-input" placeholder="Room ID">
        <button id="loginBtn" class="win98-button">Join</button>
    </div>
</div>

<script>
const socket = io();
let currentUser = null;
let bonzis = {};
let isAdmin = false;

const bonziWorld = document.getElementById('bonziWorld');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const loginModal = document.getElementById('loginModal');
const nicknameInput = document.getElementById('nicknameInput');
const roomInput = document.getElementById('roomInput');
const loginBtn = document.getElementById('loginBtn');
const uploadBtn = document.getElementById('uploadBtn');
const imageUpload = document.getElementById('imageUpload');

loginBtn.addEventListener('click', () => {
    const nickname = nicknameInput.value.trim();
    const room = roomInput.value.trim();
    if (nickname && room) {
        socket.emit('join', { nickname, room });
        loginModal.style.display = 'none';
        currentUser = nickname;
    }
});

sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

uploadBtn.addEventListener('click', () => imageUpload.click());
imageUpload.addEventListener('change', handleImageUpload);

function sendMessage() {
    const text = chatInput.value.trim();
    if (text) {
        if (text.startsWith('/')) {
            handleCommand(text);
        } else {
            socket.emit('talk', { text });
        }
        chatInput.value = '';
    }
}

function handleCommand(command) {
    const [cmd, ...args] = command.slice(1).split(' ');
    switch (cmd) {
        case 'name':
            socket.emit('changeName', { newName: args.join(' ') });
            break;
        case 'image':
            addImage(args[0]);
            break;
        case 'asshole':
            if (args[0]) socket.emit('asshole', { target: args[0] });
            break;
        case 'owo':
            if (args[0]) socket.emit('owo', { target: args[0] });
            break;
    }
}

function handleImageUpload(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            addImage(event.target.result);
        };
        reader.readAsDataURL(file);
    }
}

function addImage(url) {
    const img = new Image();
    img.src = url;
    img.style.maxWidth = '200px';
    img.style.maxHeight = '200px';
    bonzis[currentUser].speechBubble.innerHTML = '';
    bonzis[currentUser].speechBubble.appendChild(img);
    socket.emit('talk', { text: `[Image: ${url}]` });
}

class Bonzi {
    constructor(user, isAdmin = false) {
        this.user = user;
        this.element = document.createElement('div');
        this.element.className = 'bonzi';
        this.element.style.left = `${Math.random() * (window.innerWidth - 200)}px`;
        this.element.style.top = `${Math.random() * (window.innerHeight - 190)}px`;

        this.sprite = new Image();
        this.sprite.src = 'https://bonziworld.org/img/agents/purple.png';
        this.sprite.width = 200;
        this.sprite.height = 160;

        this.nameBubble = document.createElement('div');
        this.nameBubble.className = 'nameBubble';
        this.nameBubble.textContent = user;
        if (isAdmin) {
            const adminTag = document.createElement('span');
            adminTag.className = 'adminTag';
            adminTag.textContent = 'Admin';
            this.nameBubble.appendChild(adminTag);
        }

        this.speechBubble = document.createElement('div');
        this.speechBubble.className = 'speechBubble';
        this.speechBubble.style.display = 'none';

        this.element.appendChild(this.sprite);
        this.element.appendChild(this.nameBubble);
        this.element.appendChild(this.speechBubble);

        bonziWorld.appendChild(this.element);
        this.makeDraggable();
    }

    makeDraggable() {
        let isDragging = false;
        let startX, startY;

        this.element.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - this.element.offsetLeft;
            startY = e.clientY - this.element.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                this.element.style.left = `${e.clientX - startX}px`;
                this.element.style.top = `${e.clientY - startY}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    speak(text) {
        this.speechBubble.textContent = text;
        this.speechBubble.style.display = 'block';
        setTimeout(() => {
            this.speechBubble.style.display = 'none';
        }, 5000);

        // Text-to-speech
        const url = `https://www.tetyys.com/SAPI4/SAPI4?text=${encodeURIComponent(text)}&voice=${encodeURIComponent("Adult Male #2, American English (TruVoice)")}&pitch=140&speed=157`;
        const audio = new Audio(url);
        audio.play();
    }

    asshole(target) {
        this.speak(`Hey, ${target}! You're a fucking asshole!`);
    }

    owo(target) {
        this.speak(`*notices ${target}'s BonziBulgeâ„¢* owo, wat dis?`);
    }
}

socket.on('join', (user) => {
    bonzis[user.nickname] = new Bonzi(user.nickname, user.isAdmin);
});

socket.on('leave', (id) => {
    if (bonzis[id]) {
        bonzis[id].element.remove();
        delete bonzis[id];
    }
});

socket.on('talk', ({ user, text }) => {
    if (bonzis[user]) {
        bonzis[user].speak(text);
    }
});

socket.on('update', (user) => {
    if (bonzis[user.oldNickname]) {
        bonzis[user.nickname] = bonzis[user.oldNickname];
        bonzis[user.nickname].user = user.nickname;
        bonzis[user.nickname].nameBubble.textContent = user.nickname;
        delete bonzis[user.oldNickname];
    }
});

socket.on('asshole', ({ user, target }) => {
    if (bonzis[user]) {
        bonzis[user].asshole(target);
    }
});

socket.on('owo', ({ user, target }) => {
    if (bonzis[user]) {
        bonzis[user].owo(target);
    }
});

// Context menu
document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    const contextMenu = document.createElement('div');
    contextMenu.className = 'window';
    contextMenu.style.position = 'absolute';
    contextMenu.style.left = `${e.clientX}px`;
    contextMenu.style.top = `${e.clientY}px`;
    contextMenu.style.zIndex = '1000';

    const menuItems = [
        { text: 'Call an asshole', action: () => socket.emit('asshole', { target: currentUser }) },
        { text: 'Notice bulge', action: () => socket.emit('owo', { target: currentUser }) },
    ];

    if (isAdmin) {
        menuItems.push({ text: 'Kick user', action: () => socket.emit('kickUser', { user: currentUser }) });
    }

    menuItems.forEach(item => {
        const button = document.createElement('button');
        button.className = 'win98-button';
        button.textContent = item.text;
        button.onclick = () => {
            item.action();
            contextMenu.remove();
        };
        contextMenu.appendChild(button);
    });

    document.body.appendChild(contextMenu);

    const removeMenu = (e) => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.remove();
            document.removeEventListener('click', removeMenu);
        }
    };

    document.addEventListener('click', removeMenu);
});

// Initialize
loginModal.style.display = 'block';
</script>
</body>
</html>
