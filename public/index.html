<html><head><base href="https://bonziworld.org/"><title>BonziWorld</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/98.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<style>
body, html { 
    margin: 0; 
    padding: 0; 
    height: 100%; 
    overflow: hidden; 
    font-family: "MS Sans Serif", Arial, sans-serif;
    background: #008080;
}
#bonziContainer { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: calc(100% - 30px); 
}
#chatbar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30px;
    background: #c0c0c0;
    border-top: 1px solid #ffffff;
    box-shadow: inset 0 1px #dfdfdf;
}
#chatInput {
    width: calc(100% - 110px);
    height: 20px;
    margin: 5px;
    padding: 0 5px;
}
#sendButton, #uploadButton {
    width: 40px;
    height: 20px;
    margin: 5px 2px;
}
.bonzi {
    position: absolute;
    width: 200px;
    height: 160px;
    cursor: move;
}
.bonziSpeech {
    position: absolute;
    background: #ffffcc;
    border: 2px solid #000000;
    border-radius: 10px;
    padding: 5px;
    max-width: 200px;
    word-wrap: break-word;
}
.bonziName {
    position: absolute;
    background: #000080;
    color: #ffffff;
    padding: 2px 5px;
    border-radius: 5px;
    font-size: 12px;
}
.admin::after {
    content: " [ADMIN]";
    color: #ff0000;
}
.contextMenu {
    position: absolute;
    background: #c0c0c0;
    border: 1px solid #000000;
    padding: 2px;
}
.contextMenuItem {
    padding: 2px 5px;
    cursor: pointer;
}
.contextMenuItem:hover {
    background: #000080;
    color: #ffffff;
}
</style>
</head>
<body>
<div id="bonziContainer"></div>
<div id="chatbar">
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button id="sendButton">Send</button>
    <button id="uploadButton">ðŸ“·</button>
</div>

<script>
const socket = io();
let currentUser = null;
let bonzis = {};

class Bonzi {
    constructor(id, username, x, y, isAdmin = false) {
        this.id = id;
        this.username = username;
        this.isAdmin = isAdmin;
        this.element = document.createElement('div');
        this.element.className = 'bonzi';
        this.element.style.left = x + 'px';
        this.element.style.top = y + 'px';

        this.sprite = new createjs.Sprite(new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/purple.png"],
            frames: {width: 200, height: 160},
            animations: {
                idle: 0,
                enter: [277, 302, "idle", 0.25],
                leave: [16, 39, 40, 0.25]
            }
        }));

        this.stage = new createjs.Stage(document.createElement('canvas'));
        this.stage.canvas.width = 200;
        this.stage.canvas.height = 160;
        this.stage.addChild(this.sprite);

        this.element.appendChild(this.stage.canvas);

        this.speechBubble = document.createElement('div');
        this.speechBubble.className = 'bonziSpeech';
        this.speechBubble.style.display = 'none';
        this.element.appendChild(this.speechBubble);

        this.nameTag = document.createElement('div');
        this.nameTag.className = 'bonziName' + (isAdmin ? ' admin' : '');
        this.nameTag.textContent = username;
        this.element.appendChild(this.nameTag);

        document.getElementById('bonziContainer').appendChild(this.element);

        this.sprite.gotoAndPlay('enter');
        createjs.Ticker.addEventListener("tick", () => this.stage.update());

        this.makeDraggable();
        this.addContextMenu();
    }

    makeDraggable() {
        let isDragging = false;
        let startX, startY;

        this.element.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - this.element.offsetLeft;
            startY = e.clientY - this.element.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                this.element.style.left = (e.clientX - startX) + 'px';
                this.element.style.top = (e.clientY - startY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    addContextMenu() {
        this.element.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (currentUser && currentUser.isAdmin) {
                let menu = document.createElement('div');
                menu.className = 'contextMenu';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';

                let kickOption = document.createElement('div');
                kickOption.className = 'contextMenuItem';
                kickOption.textContent = 'Kick User';
                kickOption.onclick = () => {
                    socket.emit('kick', this.id);
                    menu.remove();
                };

                menu.appendChild(kickOption);
                document.body.appendChild(menu);

                document.addEventListener('click', function removeMenu() {
                    menu.remove();
                    document.removeEventListener('click', removeMenu);
                });
            }
        });
    }

    speak(text) {
        this.speechBubble.textContent = text;
        this.speechBubble.style.display = 'block';
        setTimeout(() => {
            this.speechBubble.style.display = 'none';
        }, 5000);

        let url = "https://www.tetyys.com/SAPI4/SAPI4?text=" + encodeURIComponent(text) + "&voice=" + encodeURIComponent("Adult Male #2, American English (TruVoice)") + "&pitch=140&speed=157";
        let audio = new Audio(url);
        audio.play();
    }

    remove() {
        this.sprite.gotoAndPlay('leave');
        setTimeout(() => {
            this.element.remove();
        }, 1000);
    }
}

function login() {
    let nickname = prompt("Enter your nickname:");
    let roomId = prompt("Enter room ID:");
    if (nickname && roomId) {
        socket.emit('join', { nickname, roomId });
    }
}

socket.on('connect', login);

socket.on('join', (user) => {
    let x = Math.random() * (window.innerWidth - 200);
    let y = Math.random() * (window.innerHeight - 190);
    bonzis[user.id] = new Bonzi(user.id, user.nickname, x, y, user.isAdmin);
    if (user.id === socket.id) {
        currentUser = user;
    }
});

socket.on('leave', (id) => {
    if (bonzis[id]) {
        bonzis[id].remove();
        delete bonzis[id];
    }
});

socket.on('talk', (data) => {
    if (bonzis[data.id]) {
        bonzis[data.id].speak(data.text);
    }
});

socket.on('update', (user) => {
    if (bonzis[user.id]) {
        bonzis[user.id].username = user.nickname;
        bonzis[user.id].nameTag.textContent = user.nickname;
        bonzis[user.id].isAdmin = user.isAdmin;
        bonzis[user.id].nameTag.className = 'bonziName' + (user.isAdmin ? ' admin' : '');
    }
});

document.getElementById('sendButton').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    let input = document.getElementById('chatInput');
    let text = input.value.trim();
    if (text) {
        if (text.startsWith('/')) {
            handleCommand(text);
        } else {
            socket.emit('talk', text);
        }
        input.value = '';
    }
}

function handleCommand(command) {
    let parts = command.split(' ');
    switch(parts[0]) {
        case '/name':
            if (parts[1]) socket.emit('update', { nickname: parts[1] });
            break;
        case '/image':
            if (parts[1]) socket.emit('talk', `<img src="${parts[1]}" alt="User shared image" style="max-width:200px;max-height:200px;">`);
            break;
    }
}

document.getElementById('uploadButton').addEventListener('click', () => {
    navigator.clipboard.read().then(data => {
        for (let item of data) {
            if (item.types.includes('image/png')) {
                item.getType('image/png').then(blob => {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        socket.emit('talk', `<img src="${e.target.result}" alt="User shared image" style="max-width:200px;max-height:200px;">`);
                    };
                    reader.readAsDataURL(blob);
                });
            }
        }
    });
});
</script>
</body></html>
