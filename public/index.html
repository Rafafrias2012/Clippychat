<html><head><base href="https://example.com/clippychat/">
<meta charset="UTF-8">
<title>ClippyChat - Windows 98 Style</title>
<link rel="stylesheet" href="https://unpkg.com/98.css">
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: "MS Sans Serif", Arial, sans-serif;
        background-image: url('https://i.imgur.com/vDuGhj1.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    #chatContainer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(192, 192, 192, 0.8);
        border-top: 2px solid #fff;
        border-bottom: 2px solid #000;
        padding: 5px;
    }
    #chatInput {
        width: calc(100% - 200px);
        margin-right: 5px;
    }
    #sendButton, #uploadButton {
        width: 90px;
    }
    .clippy {
        position: absolute;
        cursor: move;
    }
    .speech-bubble {
        position: absolute;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #000;
        border-radius: 10px;
        padding: 10px;
        max-width: 200px;
        z-index: 1000;
    }
    .speech-bubble:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 0;
        border: 20px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.9);
        border-bottom: 0;
        margin-left: -20px;
        margin-bottom: -20px;
    }
    .name-tag {
        position: absolute;
        background: rgba(0, 0, 128, 0.8);
        color: #fff;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 12px;
        z-index: 1001;
    }
    .admin-tag {
        background: rgba(128, 0, 0, 0.8);
        margin-left: 5px;
    }
    #loginWindow {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
    }
    #uploadButton {
        margin-left: 5px;
    }
    .shared-image {
        max-width: 150px;
        max-height: 150px;
        display: block;
        margin: 5px 0;
    }
</style>
</head>
<body>
<div id="loginWindow" class="window">
    <div class="title-bar">
        <div class="title-bar-text">Login to ClippyChat</div>
    </div>
    <div class="window-body">
        <p>Enter your nickname and room ID to join:</p>
        <div class="field-row">
            <label for="nicknameInput">Nickname:</label>
            <input id="nicknameInput" type="text">
        </div>
        <div class="field-row">
            <label for="roomInput">Room ID:</label>
            <input id="roomInput" type="text">
        </div>
        <div class="field-row">
            <button id="loginButton">Join Chat</button>
        </div>
    </div>
</div>

<div id="chatContainer">
    <input type="text" id="chatInput" class="input-text">
    <button id="sendButton">Send</button>
    <button id="uploadButton">Upload</button>
    <input type="file" id="fileInput" style="display: none;" accept="image/*">
</div>

<script>
    const socket = io();
    let nickname = '';
    let roomId = '';
    let isAdmin = false;
    const clippies = {};

    const loginButton = document.getElementById('loginButton');
    const nicknameInput = document.getElementById('nicknameInput');
    const roomInput = document.getElementById('roomInput');
    const loginWindow = document.getElementById('loginWindow');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const uploadButton = document.getElementById('uploadButton');
    const fileInput = document.getElementById('fileInput');

    loginButton.addEventListener('click', () => {
        nickname = nicknameInput.value.trim();
        roomId = roomInput.value.trim();
        if (nickname && roomId) {
            socket.emit('join', { user: nickname, room: roomId });
            loginWindow.style.display = 'none';
        }
    });

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    uploadButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);

    function sendMessage() {
        const message = chatInput.value.trim();
        if (message.startsWith('/name ')) {
            const newNickname = message.slice(6).trim();
            socket.emit('changeName', { oldName: nickname, newName: newNickname });
            nickname = newNickname;
        } else if (message) {
            socket.emit('talk', { user: nickname, text: message });
            speakMessage(message);
        }
        chatInput.value = '';
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('uploadImage', { user: nickname, image: e.target.result });
            };
            reader.readAsDataURL(file);
        }
    }

    function speakMessage(text) {
        const url = `https://www.tetyys.com/SAPI4/SAPI4?text=${encodeURIComponent(text)}&voice=${encodeURIComponent("Adult Male #2, American English (TruVoice)")}&pitch=140&speed=157`;
        const audio = new Audio(url);
        audio.play();
    }

    function createClippy(user) {
        const clippy = document.createElement('div');
        clippy.className = 'clippy';
        clippy.style.left = `${Math.random() * (window.innerWidth - 124)}px`;
        clippy.style.top = `${Math.random() * (window.innerHeight - 93)}px`;

        const sprite = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/clippy.png"],
            frames: { width: 124, height: 93 },
            animations: {
                idle: 0,
                enter: [410, 416, "idle", 0.25],
                leave: {
                    frames: [0].concat([...Array(48).keys()].map(i => i + 364)),
                    speed: 0.25
                }
            }
        });

        const animation = new createjs.Sprite(sprite, "enter");
        const stage = new createjs.Stage(document.createElement('canvas'));
        stage.canvas.width = 124;
        stage.canvas.height = 93;
        stage.addChild(animation);
        clippy.appendChild(stage.canvas);

        const nameTag = document.createElement('div');
        nameTag.className = 'name-tag';
        nameTag.textContent = user;
        if (isAdmin) nameTag.innerHTML += '<span class="admin-tag">Admin</span>';
        clippy.appendChild(nameTag);

        const speechBubble = document.createElement('div');
        speechBubble.className = 'speech-bubble';
        speechBubble.style.display = 'none';
        clippy.appendChild(speechBubble);

        document.body.appendChild(clippy);
        clippies[user] = { element: clippy, animation, stage, speechBubble };

        makeDraggable(clippy);
        createjs.Ticker.addEventListener("tick", stage);
    }

    function makeDraggable(element) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        element.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    function showSpeechBubble(user, content) {
        const clippy = clippies[user];
        if (clippy) {
            clippy.speechBubble.innerHTML = content;
            clippy.speechBubble.style.display = 'block';
            setTimeout(() => {
                clippy.speechBubble.style.display = 'none';
            }, 5000);
        }
    }

    socket.on('join', (data) => {
        createClippy(data.user);
        clippies[data.user].animation.gotoAndPlay("enter");
    });

    socket.on('leave', (id) => {
        if (clippies[id]) {
            clippies[id].animation.gotoAndPlay("leave");
            setTimeout(() => {
                clippies[id].element.remove();
                delete clippies[id];
            }, 2000);
        }
    });

    socket.on('update', (data) => {
        if (clippies[data.oldName]) {
            const clippy = clippies[data.oldName];
            delete clippies[data.oldName];
            clippies[data.newName] = clippy;
            clippy.element.querySelector('.name-tag').textContent = data.newName;
        }
    });

    socket.on('talk', (data) => {
        showSpeechBubble(data.user, data.text);
        speakMessage(data.text);
    });

    socket.on('uploadImage', (data) => {
        const imageElement = document.createElement('img');
        imageElement.src = data.image;
        imageElement.className = 'shared-image';
        imageElement.alt = `Image shared by ${data.user}`;
        showSpeechBubble(data.user, 'Shared an image!');
        clippies[data.user].speechBubble.appendChild(imageElement);
    });

    // Context menu for admin actions
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (isAdmin) {
            const contextMenu = document.createElement('div');
            contextMenu.className = 'window';
            contextMenu.style.position = 'absolute';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.zIndex = '2000';

            const kickButton = document.createElement('button');
            kickButton.textContent = 'Kick User';
            kickButton.onclick = () => {
                const user = prompt('Enter username to kick:');
                if (user) socket.emit('kickUser', { user });
                document.body.removeChild(contextMenu);
            };

            const banButton = document.createElement('button');
            banButton.textContent = 'Ban User';
            banButton.onclick = () => {
                const user = prompt('Enter username to ban:');
                const reason = prompt('Enter ban reason:');
                const length = prompt('Enter ban length (in minutes):');
                if (user && reason && length) {
                    socket.emit('banUser', { user, reason, length });
                }
                document.body.removeChild(contextMenu);
            };

            const muteButton = document.createElement('button');
            muteButton.textContent = 'Mute User';
            muteButton.onclick = () => {
                const user = prompt('Enter username to mute:');
                if (user) socket.emit('muteUser', { user });
                document.body.removeChild(contextMenu);
            };

            contextMenu.appendChild(kickButton);
            contextMenu.appendChild(banButton);
            contextMenu.appendChild(muteButton);
            document.body.appendChild(contextMenu);

            const closeContextMenu = (e) => {
                if (!contextMenu.contains(e.target)) {
                    document.body.removeChild(contextMenu);
                    document.removeEventListener('click', closeContextMenu);
                }
            };
            document.addEventListener('click', closeContextMenu);
        }
    });

    // Clipboard paste handling
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.emit('uploadImage', { user: nickname, image: event.target.result });
                };
                reader.readAsDataURL(blob);
            }
        }
    });
</script>
</body></html>
